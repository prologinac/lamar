const { 

    default: makeWASocket, 

    useMultiFileAuthState, 

    delay, 

    makeCacheableSignalKeyStore,

    fetchLatestBaileysVersion,

    DisconnectReason

} = require("@whiskeysockets/baileys");

const pino = require('pino');

const fs = require('fs');

const path = require('path');

module.exports = async (sock, chatId, m, handleMessages) => {

    try {

        const text = (m.message?.conversation || m.message?.extendedTextMessage?.text || "");

        let targetNumber = text.split(' ')[1] || m.key.participant || m.key.remoteJid;

        targetNumber = targetNumber.replace(/[^0-9]/g, '');

        if (targetNumber.length < 10) {

            return sock.sendMessage(chatId, { text: "âŒ *Usage:* `.jadibot 2557xxx`" });

        }

        // 1. FRESH START: Kill any "stuck" session attempts for this number

        const sessionPath = `./session/subbots/${targetNumber}`;

        if (fs.existsSync(sessionPath)) {

            fs.rmSync(sessionPath, { recursive: true, force: true });

        }

        fs.mkdirSync(sessionPath, { recursive: true });

        const { state, saveCreds } = await useMultiFileAuthState(sessionPath);

        const { version } = await fetchLatestBaileysVersion();

        // 2. STABLE CONFIGURATION

        const subSock = makeWASocket({

            version,

            auth: {

                creds: state.creds,

                keys: makeCacheableSignalKeyStore(state.keys, pino({ level: "fatal" })),

            },

            printQRInTerminal: false,

            logger: pino({ level: 'silent' }),

            // HIGH-TRUST BROWSER: mimic Windows Chrome to bypass strict mobile pairing filters

            browser: ["Windows", "Chrome", "114.0.5735.198"], 

            markOnlineOnConnect: false,

            syncFullHistory: false,

            // EXTENDED TIMEOUT: prevents the 'Long Loading' crash

            connectTimeoutMs: 120000, 

            defaultQueryTimeoutMs: 0

        });

        subSock.ev.on('creds.update', saveCreds);

        // 3. THE HANDSHAKE PROTOCOL

        if (!subSock.authState.creds.registered) {

            await sock.sendMessage(chatId, { text: "â³ *MADRIN-MD* is warming up the connection...\n_This takes 20 seconds to prevent login errors._" });

            

            // CRITICAL: We wait for the socket to 'Connecting' state before requesting

            await delay(20000); 

            try {

                const code = await subSock.requestPairingCode(targetNumber);

                const formattedCode = code?.match(/.{1,4}/g)?.join("-") || code;

                

                await sock.sendMessage(chatId, { 

                    text: `âœ… *CODE: ${formattedCode}*\n\n1. Go to Settings > Linked Devices\n2. Link with phone number\n3. Enter the code above.\n\n_If you don't see the code box on your phone, restart WhatsApp and try linking again._` 

                }, { quoted: m });

            } catch (err) {

                console.error("Pairing Error:", err);

                await sock.sendMessage(chatId, { text: "âŒ *WhatsApp Refused the Request.*\nTry again in 5 minutes. Do not spam the command." });

                return;

            }

        }

        // 4. EVENT LISTENERS

        subSock.ev.on('connection.update', async (update) => {

            const { connection, lastDisconnect } = update;

            if (connection === 'open') {

                await sock.sendMessage(chatId, { text: `ðŸš€ *SUCCESS!* Your sub-bot is now active.` });

            }

            if (connection === 'close') {

                console.log(`Sub-bot ${targetNumber} closed.`);

            }

        });

        subSock.ev.on('messages.upsert', async (chatUpdate) => {

            await handleMessages(subSock, chatUpdate); 

        });

    } catch (e) {

        console.error("Jadibot Error:", e);

    }

};

